# MaskDetection — детекция людей и привязка к реальным координатам

Проект на базе [YOLOv5 CrowdHuman ONNX](https://github.com/yakhyo/yolov5-crowdhuman-onnx): детекция людей по видеопотоку (RTSP/веб-камера) с помощью YOLOv5m (CrowdHuman), привязка пикселей кадра к реальным координатам через гомографию и отправка результатов по ZMQ/UDP.

## Архитектура

- **Основа:** [yakhyo/yolov5-crowdhuman-onnx](https://github.com/yakhyo/yolov5-crowdhuman-onnx) — детекция людей (ONNX Runtime, модель обучена на CrowdHuman).
- **Дополнения:**
  - **homography_service.py** — привязка пикселей кадра к реальным координатам: по 4+ парам точек (пиксель ↔ реальные x,y) считается матрица гомографии и сохраняется в JSON.
  - **process_points.py** — по результатам детекции определяет реальные координаты точек интереса (для каждой точки интереса — ближайший человек, затем гомография), формирует результат и отправляет его (ZMQ между детекцией и этим модулем; итоговые координаты — на стенд по UDP).
  - **app.py** — веб-приложение (Flask) для настройки: источник видео, параметры детекции, точки гомографии, точки интереса, запуск/остановка детекции и процесса расчёта координат.

Данные между детекцией и расчётом координат передаются по **ZMQ** (PUSH/PULL). Итоговая выдача координат — на указанный в конфиге хост/порт (в текущей реализации — UDP).

## Компоненты

| Компонент | Назначение |
|-----------|------------|
| **object_detection.py** | Детекция людей (YOLOv5 ONNX), координаты «низ центра» бокса по кадрам, отправка списка точек в ZMQ. |
| **homography_service.py** | Расчёт и сохранение матрицы гомографии по парам (пиксель → реальные x,y). |
| **process_points.py** | Приём по ZMQ списка людей с кадра, сопоставление с точками интереса, перевод в реальные координаты (гомография), отправка на стенд. |
| **app.py** | Веб-интерфейс: конфиг, снимок с камеры, точки гомографии, точки интереса, старт/стоп детекции и process_points. |

## Поток данных

1. **Видео** (RTSP/веб-камера/файл) → **object_detection.py** → детекции людей, координаты нижней середины боксов.
2. **object_detection.py** → **ZMQ (PUSH)** → **process_points.py** (PULL) — передаётся JSON со списком пиксельных координат людей.
3. **process_points.py** загружает точки интереса (`points.json`) и матрицу гомографии (`homography_matrix.json`), для каждой точки интереса находит ближайшего человека, переводит его координаты в реальные и отправляет результат на стенд (IP/порт из `config.json`, сейчас по UDP).

## Установка

1. Клонировать репозиторий и перейти в каталог:
   ```bash
   git clone <url-репозитория>
   cd MaskDetection
   ```

2. Установить зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Скачать веса модели YOLOv5m (CrowdHuman) в формате ONNX и положить в `weights/`:
   - [crowdhuman.onnx](https://github.com/yakhyo/yolov5-crowdhuman-onnx/releases/download/v0.0.1/crowdhuman.onnx) (≈84 MB, FP32)

## Настройка (веб-приложение)

1. Запустить веб-приложение:
   ```bash
   python app.py
   ```
   По умолчанию сервер доступен по адресу вида `http://127.0.0.1:5000`.

2. В веб-интерфейсе:
   - **Конфиг** — источник видео (RTSP URL или `0` для веб-камеры), путь к весам, пороги и размер изображения, IP/порт стенда и т.д. Сохраняется в `config.json`.
   - **Гомография** — загрузить снимок с камеры, указать 4+ пары (пиксель ↔ реальные x,y), применить. Используются `homography_service.py`, сохраняются `homography_matrix.json` и `homography_points.json`.
   - **Точки интереса** — задать пиксельные точки интереса на кадре. Сохраняются в `points.json`.

3. С главной страницы можно запускать/останавливать:
   - процесс детекции (**object_detection.py** с параметрами из конфига);
   - процесс расчёта координат и отправки на стенд (**process_points.py**).

Перед запуском process_points нужно настроить гомографию и точки интереса; детекция при запуске из веб-интерфейса читает `config.json` и создаёт/обновляет `zmq_endpoint.json` для связи с process_points.

## Конфигурационные файлы

| Файл | Описание |
|------|----------|
| **config.json** | RTSP/источник видео, путь к весам, пороги детекции, размер кадра, `standIp`/`standPort` для отправки координат, опции view/save. |
| **points.json** | Точки интереса в пикселях: `[{"x": ..., "y": ...}, ...]`. |
| **homography_points.json** | Пары для гомографии (пиксель + реальные x,y). |
| **homography_matrix.json** | Матрица 3×3 гомографии (заполняется homography_service). |
| **zmq_endpoint.json** | Endpoint ZMQ, куда object_detection отдаёт данные (создаётся при запуске детекции). |

## Запуск без веб-интерфейса

- Детекция (и ZMQ):
  ```bash
  python object_detection.py --weights=weights/crowdhuman.onnx --source=0 --view
  ```
  После старта в `zmq_endpoint.json` появится адрес, к которому подключается process_points.

- Расчёт координат и отправка на стенд (после настройки гомографии и точек):
  ```bash
  python process_points.py
  ```

## Структура проекта

```
MaskDetection/
├── app.py                  # Flask: настройка и управление
├── object_detection.py     # Детекция людей + отправка координат по ZMQ
├── homography_service.py   # Расчёт и сохранение матрицы гомографии
├── process_points.py       # Точки интереса → реальные координаты → стенд
├── config.json             # Настройки (источник, стенд, детекция)
├── points.json             # Точки интереса (пиксели)
├── homography_points.json  # Точки для гомографии
├── homography_matrix.json  # Матрица гомографии
├── zmq_endpoint.json       # ZMQ endpoint (создаётся при запуске детекции)
├── models/                 # Модель YOLOv5 (из базового репозитория)
├── utils/                  # Утилиты (из базового репозитория)
├── weights/                # Веса ONNX (crowdhuman.onnx)
├── static/                 # Статика веб-приложения (снимки и т.д.)
├── templates/              # Шаблоны страниц (home, config, homography, points)
└── requirements.txt
```

## Зависимости

Основные: `opencv-python`, `numpy`, `onnx`, `onnxruntime-gpu`, `torch`, `torchvision`, `flask`, `pyzmq`. Точные версии — в `requirements.txt`.

## Базовый репозиторий

Детекция людей построена на проекте:

- [yakhyo/yolov5-crowdhuman-onnx](https://github.com/yakhyo/yolov5-crowdhuman-onnx) — YOLOv5m, CrowdHuman, ONNX Runtime.  
- Модель: [crowdhuman.onnx](https://github.com/yakhyo/yolov5-crowdhuman-onnx/releases/download/v0.0.1/crowdhuman.onnx).

В данном проекте поверх него добавлены гомография, точки интереса, веб-настройка и передача результатов по ZMQ и на стенд (UDP).
