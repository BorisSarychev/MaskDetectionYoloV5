{% extends "base.html" %}
{% block content %}

<style>
  .marker {
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: red;
    border-radius: 50%;
    transform: translate(-50%, -50%);
  }
  .marker-label {
    position: absolute;
    top: -20px;
    left: 0;
    background-color: #fff;
    padding: 1px 4px;
    border: 1px solid #ccc;
    font-size: 12px;
    transform: translate(-50%, 0);
    white-space: nowrap;
  }
</style>

<h1>Точки интереса</h1>

<!-- Кнопка для обновления снимка -->
<button id="refreshSnapshotBtn" class="btn btn-primary mb-3">Обновить снимок</button>

<!-- Контейнер (position: relative), картинка масштабирована до 600px -->
<div id="snapshotContainer" style="position: relative; display: inline-block;">
  <img 
    id="snapshotImg"
    src="/static/images/snapshot.jpg"
    style="width:600px; border:1px solid #ccc; cursor: crosshair;"
    alt="snapshot"
  >
</div>

<hr/>

<h3>Список точек</h3>
<table class="table table-bordered table-sm" id="pointsTable">
  <thead>
    <tr>
      <th>#</th>
      <th>X (px)</th>
      <th>Y (px)</th>
      <th>Удалить</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Убрана кнопка "Добавить точку" -->

<!-- Кнопка "Сохранить" (POST /api/save_points) -->
<button id="savePointsBtn" class="btn btn-success">Сохранить</button>

<script>
// Массив точек [{ x, y }], где x,y — ОРИГИНАЛЬНЫЕ координаты
let points = [];

// Ссылки на DOM-элементы
const snapshotImg = document.getElementById("snapshotImg");
const snapshotContainer = document.getElementById("snapshotContainer");
const pointsTableBody = document.querySelector("#pointsTable tbody");
const refreshSnapshotBtn = document.getElementById("refreshSnapshotBtn");
const savePointsBtn = document.getElementById("savePointsBtn");

/* --------------------------------------------------
   1) ЗАГРУЗКА ТОЧЕК (из /api/load_points)
-------------------------------------------------- */
async function loadPointsFromServer() {
  try {
    const resp = await fetch("/api/load_points");
    const data = await resp.json(); 
    // data – ожидаем [{"x":..., "y":...}, ...]
    points = data;
    renderTable();
    safeDrawMarkers();
  } catch (err) {
    console.error("Ошибка при загрузке points.json:", err);
  }
}

/* --------------------------------------------------
   2) РЕНДЕР ТАБЛИЦЫ
-------------------------------------------------- */
function renderTable() {
  pointsTableBody.innerHTML = "";
  points.forEach((pt, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${pt.x}</td>
      <td>${pt.y}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deletePoint(${idx})">Удалить</button>
      </td>
    `;
    pointsTableBody.appendChild(tr);
  });
}

/* --------------------------------------------------
   3) БЕЗОПАСНАЯ ОТРИСОВКА МАРКЕРОВ
   (учитываем, что картинка может быть не загружена)
-------------------------------------------------- */
function safeDrawMarkers() {
  if (!snapshotImg.complete || snapshotImg.naturalWidth === 0) {
    snapshotImg.addEventListener("load", drawMarkers, { once: true });
  } else {
    drawMarkers();
  }
}

/* --------------------------------------------------
   4) DRAW MARKERS
   Переводим (x,y) оригинальные -> отображаемые
-------------------------------------------------- */
function drawMarkers() {
  snapshotContainer.querySelectorAll(".marker").forEach(m => m.remove());

  points.forEach((pt, idx) => {
    const { dispX, dispY } = originalToDisplayed(pt.x, pt.y);
    const marker = document.createElement("div");
    marker.className = "marker";
    marker.style.left = dispX + "px";
    marker.style.top = dispY + "px";

    const label = document.createElement("div");
    label.className = "marker-label";
    label.innerText = (idx + 1).toString();

    marker.appendChild(label);
    snapshotContainer.appendChild(marker);
  });
}

/* --------------------------------------------------
   5) ПРЕОБРАЗОВАНИЕ (ORIGINAL -> DISPLAYED)
-------------------------------------------------- */
function originalToDisplayed(ox, oy) {
  const naturalW = snapshotImg.naturalWidth;   // исходная ширина
  const naturalH = snapshotImg.naturalHeight;  // исходная высота
  const renderedW = snapshotImg.clientWidth;   // отображаемая ширина
  const renderedH = snapshotImg.clientHeight;  // отображаемая высота

  const scaleX = renderedW / naturalW;
  const scaleY = renderedH / naturalH;

  return {
    dispX: ox * scaleX,
    dispY: oy * scaleY
  };
}

/* --------------------------------------------------
   6) УДАЛЕНИЕ ТОЧКИ
-------------------------------------------------- */
function deletePoint(index) {
  points.splice(index, 1);
  renderTable();
  safeDrawMarkers();
}

/* --------------------------------------------------
   7) КЛИК ПО ИЗОБРАЖЕНИЮ
   Берём displayed coords -> переводим в original
-------------------------------------------------- */
snapshotImg.addEventListener("click", (e) => {
  const rect = snapshotImg.getBoundingClientRect();
  const displayedX = e.clientX - rect.left;
  const displayedY = e.clientY - rect.top;

  const naturalW = snapshotImg.naturalWidth;
  const naturalH = snapshotImg.naturalHeight;
  const renderedW = snapshotImg.clientWidth;
  const renderedH = snapshotImg.clientHeight;

  const scaleX = naturalW / renderedW;
  const scaleY = naturalH / renderedH;

  const originalX = Math.round(displayedX * scaleX);
  const originalY = Math.round(displayedY * scaleY);

  points.push({ x: originalX, y: originalY });
  renderTable();
  safeDrawMarkers();
});

/* --------------------------------------------------
   8) ОБНОВИТЬ СНАПШОТ
-------------------------------------------------- */
refreshSnapshotBtn.addEventListener("click", async () => {
  try {
    const resp = await fetch("/api/get_snapshot");
    const data = await resp.json();
    if (data.snapshotUrl) {
      snapshotImg.src = data.snapshotUrl + "?ts=" + Date.now();
    } else if (data.error) {
      alert("Ошибка: " + data.error);
    }
  } catch (err) {
    console.error(err);
    alert("Ошибка при обновлении снимка");
  }
});

/* --------------------------------------------------
   9) "СОХРАНИТЬ" -> POST /api/save_points
-------------------------------------------------- */
savePointsBtn.addEventListener("click", async () => {
  try {
    const resp = await fetch("/api/save_points", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ points }),
    });
    const result = await resp.json();
    if (resp.ok) {
      alert("Точки успешно сохранены!");
    } else {
      alert("Ошибка сохранения: " + result.message);
    }
  } catch (err) {
    console.error("Ошибка:", err);
    alert("Ошибка при сохранении");
  }
});

/* --------------------------------------------------
   10) ПРИ ЗАГРУЗКЕ СТРАНИЦЫ -> подгружаем точки
-------------------------------------------------- */
window.addEventListener("load", () => {
  loadPointsFromServer();
});
</script>

{% endblock %}
